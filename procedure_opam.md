# How to make an OPAM package

This page explains how to make a OPAM package accessible from a local repository.
It means that the package won't directly be accessible from the official OPAM repository, but the user will need to `opam repo add` your local repository.

The running example will be to make an opam package for a library called Foo.

## Creation of a repository opam-foo

This repository contains data used by OPAM to build Foo.
Two files are necesary at the end, _index.tar.gz_ and _urls.txt_.
We will detail their content later.
First, let us see how a package is represented for OPAM.

### Content of package files
Let us make a directory _packages_ containing the (possibly several) packages you want OPAM to be aware of.
Here, let us call our package _foo_. Directory _packages_ thus contains a directory _foo_.

Our package _foo_ may have several accessible versions.
Each version is stored into a directory _foo.version_ within directory _foo_.
Let us assume that _foo_ has two versions 1.0 and 1.1: directory _foo_ thus contains _foo.1.0_ and _foo.1.1_

Finally each version directory must have three files:

* _url_: the url where to find the library. For instance
    `git: "https://github.com/Foo#1.0"`

* _descr_: a description of the library

* _opam_: a file describing various data about the library, such as its dependencies and how to compile it. For instance

    ```
    opam-version: "1.2.2"
    maintainer: "Jean-Michel Jarre <jean-michel.jarre@lip6.fr>"
    authors: [
      "Jean-Michel Jarre <jean-michel.jarre@lip6.fr>"
      "Doroth√©e <dorothee.lip6.fr>"
    ]
    homepage: "https://github.com/Foo"
    bug-reports: "https://github.com/Foo/issues"
    license: "LGPL"
    dev-repo: "https://github.com/Foo"
    build: ["make"]
    install: ["make" "install"]
    build-test: ["make" "test"]
    remove: ["ocamlfind" "remove" "foo"]
    depends: [
      "base-unix"
      "ocamlbuild" {build}
      "ocamlfind" {build}
      "zarith"
    ]
    available: [ocaml-version >= "4.02.1" & ocaml-version < "4.06~"]
    ```

### Building files for OPAM

As said above, OPAM actually needs two files _index.tar.gz_ and _urls.txt_.

* _index.tar.gz_ is simply an archive made of the directory _packages_ defined above.

* _urls.txt_ contains a relative path to each file of _packages_ with a checksum. For instance
```
packages/foo/foo.1.1/url c0330a844c91a19c01c1600e2f4b6880 0o664
packages/foo/foo.1.1/opam 709edbe12034f343663afcaf720af65e 0o664
packages/foo/foo.1.1/descr 655bf4375650f1717b8dd0047eaae7a4 0o664
packages/foo/foo.1.0/url 86cdba2bc7799fef2cedf49ead39011a 0o664
packages/foo/foo.1.0/opam 709edbe12034f343663afcaf720af65e 0o664
packages/foo/foo.1.0/descr 655bf4375650f1717b8dd0047eaae7a4 0o664
```

These two files can be generated by the following command, run at the repository root
    `opam-admin make`

### Repository state
At the end, the opam-foo repository should have:

* A directory _packages_ containing files for each version of _foo_

* A file _urls.txt_

* A file _index.tar.gz_

# From the user point of view

To build the Foo library, the user has to add the _opam-foo_ repository into OPAM (caution: the files must be directly downloadable from this link, hence the `raw...`):

`opam repo add foo https://raw.githubusercontent.com/opam-foo/master`

Then, the library is installed simply by `opam install foo` or `opam install foo.1.1` to specify a particular version.
